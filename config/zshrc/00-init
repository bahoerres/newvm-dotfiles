# -----------------------------------------------------
# INIT (load early)
# -----------------------------------------------------

# --- Basic env
export EDITOR=${EDITOR:-nvim}
export PAGER=${PAGER:-less}
export LESS='-R --use-color -Dd+r$Du+b'   # nicer man page colors

# --- Paths
path=(
  /usr/lib/ccache/bin
  $path
)

# --- Shell behavior
setopt autocd extendedglob chase_links
setopt interactivecomments
setopt promptsubst
unsetopt beep

# --- Completions (must be early)
# Arch's zsh-completions ships to site-functions
fpath=(/usr/share/zsh/site-functions $fpath)

# Cache compdump in XDG cache
ZCDIR=${XDG_CACHE_HOME:-$HOME/.cache}/zsh
mkdir -p "$ZCDIR"

autoload -Uz compinit
zmodload -i zsh/complist
# Fast + versioned compdump
compinit -d "$ZCDIR/zcompdump-$ZSH_VERSION"

# --- Completion styles (global defaults; more in 20-customization)
zstyle ':completion:*' menu select                         # arrowable menus
zstyle ':completion:*' matcher-list '' 'm:{a-z}={A-Z}' '+l:|=* r:|=*'
zstyle ':completion:*' group-name ''                       # group matches
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}      # colorize files
zstyle ':completion:*' squeeze-slashes true
zstyle ':completion:*' special-dirs true
zstyle ':completion:*' rehash true                         # pick up new cmds

# Offer context-aware stuff for common tools
zstyle ':completion:*:(ssh|scp|sftp|rsync):*' tag-order 'hosts:-host:host\ list' files
zstyle ':completion:*:kill:*' command 'ps -o pid,user,cmd -A'
zstyle ':completion:*:sudo:*' command-path /usr/sbin /usr/bin /sbin /bin

# Completer chain (fast â†’ tolerant)
zstyle ':completion:*' completer _complete _correct _approximate

# --- History (large & sane)
HISTFILE=${HISTFILE:-$HOME/.zsh_history}
HISTSIZE=100000
SAVEHIST=100000
setopt appendhistory inc_append_history sharehistory
setopt hist_ignore_all_dups hist_ignore_space hist_reduce_blanks
setopt hist_verify

# --- Keymaps
bindkey -e                                        # emacs mode (default zsh keybindings)
bindkey '^[[Z' reverse-menu-complete               # Shift-Tab reverse
bindkey -M menuselect '^M' .accept-line            # Enter confirms in menu

# --- Safety: fix noisy compaudit if needed (uncomment the chmod once if it yells)
# compaudit | xargs -r -I {} echo "insecure: {}"
# chmod -R go-w ~/.config/zshrc ~/.zshrc ~/.cache/zsh ~/.zsh_history 2>/dev/null

